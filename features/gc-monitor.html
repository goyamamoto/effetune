<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GC Monitor</title>
    <link rel="stylesheet" href="../effetune.css">
    <link rel="icon" href="../images/favicon.ico" type="image/x-icon">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        body {
            background: #1e1e1e;
            color: #fff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }
        #gcChart {
            width: 100%;
            height: 300px;
        }
        .back-button {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <button id="back-button" class="back-button">Back to EffeTune</button>
    <h1>Garbage Collection Monitor</h1>
    <canvas id="gcChart"></canvas>
    <div id="log" style="white-space: pre-line; font-family: monospace; margin-top: 10px;"></div>
    <script>
        const ctx = document.getElementById('gcChart').getContext('2d');
        const startTime = Date.now();
        const data = {
            datasets: [
                {
                    label: 'Used JS Heap (MB)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                },
                {
                    label: 'GC Event',
                    data: [],
                    type: 'scatter',
                    backgroundColor: 'red',
                    pointRadius: 4
                }
            ]
        };
        const chart = new Chart(ctx, {
            type: 'line',
            data: data,
            options: {
                animation: false,
                scales: {
                    x: {
                        type: 'linear',
                        title: { display: true, text: 'Time (s)', color: 'white' }
                    },
                    y: { beginAtZero: true }
                },
                plugins: { legend: { labels: { color: 'white' } } }
            }
        });

        function updateMemory() {
            if (performance && performance.memory) {
                const usedMB = performance.memory.usedJSHeapSize / 1048576;
                const t = (Date.now() - startTime) / 1000;
                chart.data.datasets[0].data.push({ x: t, y: usedMB });
                chart.update('none');
            }
        }
        setInterval(updateMemory, 1000);

        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'gc-event') {
                const entry = event.data.entry;
                const usedMB = performance.memory ? performance.memory.usedJSHeapSize / 1048576 : 0;
                const t = (Date.now() - startTime) / 1000;
                chart.data.datasets[1].data.push({ x: t, y: usedMB });
                const logEl = document.getElementById('log');
                logEl.textContent += `GC ${entry.detail.kind} at ${entry.startTime.toFixed(1)} ms, duration ${entry.duration.toFixed(3)} ms\n`;
                chart.update('none');
            }
        });

        const backBtn = document.getElementById('back-button');
        backBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.navigateToMain();
            } else {
                window.location.href = '../effetune.html';
            }
        });

        window.addEventListener('load', () => {
            if (window.gcMonitor) window.gcMonitor.start();
            if (window.electronAPI) window.electronAPI.hideApplicationMenu();
        });

        window.addEventListener('beforeunload', () => {
            if (window.gcMonitor) window.gcMonitor.stop();
            if (window.electronAPI) window.electronAPI.restoreDefaultMenu();
        });
    </script>
</body>
</html>
